<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ddbAPIdapter - A Simple DDB API Converter</title>

    <!-- Favicon -->
    <link rel="icon" href="/ddbAPIdapter/favicon.ico" type="image/x-icon">

    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Prism.js for JSON syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism.min.css" rel="stylesheet" />
  
    <style>

    #logo {
    vertical-align: middle; /* Align the logo with the text */
    width: 150px; /* Adjust the size of the logo */
    height: auto;
    margin-right: 10px; /* Add spacing between the logo and the title */
}

        .output-box {
            display: flex;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 20px; /* Add margin here for optical distance */
        }
        .output {
            width: 100%;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            word-break: break-all;
        }
        .copy-icon {
            cursor: pointer;
            font-size: 24px;
            margin-left: 10px;
        }
        #apiResult {
            width: 100%;
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            max-height: 800px;
            overflow-y: auto;
            resize: both; /* Allows resizing in both directions */
            min-height: 100px; /* Set a minimum height */
        }
        footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        footer a {
            color: inherit;
            text-decoration: none;
        }
        footer img {
            vertical-align: middle;
            margin-right: 5px;
        }
        .footer-icons img {
            margin-right: 10px;
        }
        .footer-icons a {
            margin-right: 60px;
        } 
        .card-body {
            padding: 0px;
        }
        /* Make the accordion more compact */
        .accordion .card-header {
            padding: 5px 10px;  /* Reduce padding in the accordion header */
            font-size: 0.9rem;  /* Reduce font size of the accordion header */
            background-color: #f8f9fa; /* Keep a subtle background */
            border: 1px solid #ddd;  /* Lighter border for a less obtrusive look */
        }

        .accordion .card-body {
            padding: 10px;  /* Reduce padding inside the accordion content */
            font-size: 0.9rem;  /* Make the content font size smaller */
            border-top: 1px solid #ddd;
        }

        .accordion .card {
            border: none;  /* Remove the outer border of the card to make it less obtrusive */
            margin-bottom: 5px;  /* Decrease spacing between accordion cards */
        }

        .accordion .btn-link {
            font-size: 0.9rem;  /* Reduce font size of the button */
            text-decoration: none;  /* Remove underline */
            color: #007bff;  /* Use a subtle blue color */
            padding: 0;  /* Remove padding for a tighter look */
        }


    </style>
</head>
<body class="container">

    <h1 class="my-4">
        <img src="logo.png" alt="Logo" id="logo" class="mr-3">
        ddbAPIdapter
    </h1>
    <p>A simple tool that translates a <a href="https://www.deutsche-digitale-bibliothek.de/">Deutsche Digitale Bibliothek (DDB)</a> search URL into a DDB API call.</p>
    
    <div class="form-group">
        <label for="urlInput">URL:</label>
        <input type="text" id="urlInput" class="form-control" placeholder="Enter the search URL">
    </div>
    
    <div class="form-group">
        <label for="apiKeyInput">API Key (optional):</label>
        <input type="text" id="apiKeyInput" class="form-control" value="API-KEY">
    </div>
    
    <button id="convertButton" class="btn btn-primary mb-3">Convert</button>
    
    <div class="output-box">
        <div id="outputUrl" class="output"></div>
        <span id="copyUrlButton" class="copy-icon" title="Copy to clipboard">ðŸ“‹</span>
    </div>

    <!-- Accordion for CURL and Python requests outputs -->
<div class="accordion" id="outputAccordion">
    <!-- CURL Command -->
    <div class="card">
      <div class="card-header" id="headingTwo">
        <h2 class="mb-0">
          <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
            CURL Command
          </button>
        </h2>
      </div>
      <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#outputAccordion">
        <div class="card-body">
          <div class="output-box">
            <pre id="outputCurl" class="output"></pre>
            <span id="copyCurlButton" class="copy-icon" title="Copy to clipboard">ðŸ“‹</span>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Python requests Code -->
    <div class="card">
      <div class="card-header" id="headingThree">
        <h2 class="mb-0">
          <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
            Python requests Code
          </button>
        </h2>
      </div>
      <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#outputAccordion">
        <div class="card-body">
          <div class="output-box">
            <pre id="outputPython" class="output"></pre>
            <span id="copyPythonButton" class="copy-icon" title="Copy to clipboard">ðŸ“‹</span>
          </div>
        </div>
      </div>
    </div>
  </div>
    
    <button id="tryItButton" class="btn btn-success mt-3">Try it out!</button>

    <h2 class="my-4">API Result</h2>
    <div class="output-box">
        <pre id="apiResult"><code class="language-json">No result yet.</code></pre>
        <span id="copyResultButton" class="copy-icon" title="Copy to clipboard">ðŸ“‹</span>
    </div>
    

    <footer>
        <p>This application was created using ChatGPT 4.0.</p>
        <p>Prompting was done by Alexander Winkler.</p>
        <div class="footer-icons">
            <a href="https://orcid.org/0000-0002-9145-7238" target="_blank">
                <img src="https://upload.wikimedia.org/wikipedia/commons/0/06/ORCID_iD.svg" alt="ORCID logo" width="16" height="16">ORCID: https://orcid.org/0000-0002-9145-7238
            </a>
            <a href="https://github.com/alexander-winkler/ddbAPIdapter" target="_blank">
                <img src="https://cdn-icons-png.flaticon.com/512/25/25231.png" alt="GitHub logo" width="16" height="16">GitHub: ddbAPIdapter
            </a>
        </div>
    </footer>

     <!-- Prism.js -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-json.min.js"></script>
     
    
    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        let apiUrl = '';
    
        // Event listener for the Convert button
document.getElementById('convertButton').addEventListener('click', function() {
    const queryUrl = document.getElementById('urlInput').value;
    const apiKey = document.getElementById('apiKeyInput').value.trim() || "API-KEY";
    
    // Update the API URL each time Convert is clicked
    apiUrl = search2API(queryUrl, apiKey);
    
     // Only update the output if a valid API URL was returned
     if (apiUrl) {
        document.getElementById('outputUrl').textContent = apiUrl;

        // Generate and display the curl command in the accordion
        const curlCommand = generateCurlCommand(apiUrl, apiKey);
        document.getElementById('outputCurl').textContent = curlCommand;

        // Generate and display the Python requests code in the accordion
        const pythonCode = generatePythonCode(apiUrl, apiKey);
        document.getElementById('outputPython').textContent = pythonCode;
    }
});

    
// Event listener for copying the API URL
document.getElementById('copyUrlButton').addEventListener('click', function() {
    const output = document.getElementById('outputUrl').textContent.trim();
    if (output === "") {
        alert('The API URL output is empty. Nothing to copy!');
    } else {
        navigator.clipboard.writeText(output).then(() => {
            alert('API URL copied to clipboard!');
        });
    }
});

// Event listener for copying the CURL command
document.getElementById('copyCurlButton').addEventListener('click', function() {
    const output = document.getElementById('outputCurl').textContent.trim();
    if (output === "") {
        alert('The CURL command output is empty. Nothing to copy!');
    } else {
        navigator.clipboard.writeText(output).then(() => {
            alert('CURL command copied to clipboard!');
        });
    }
});

// Event listener for copying the Python requests code
document.getElementById('copyPythonButton').addEventListener('click', function() {
    const output = document.getElementById('outputPython').textContent.trim();
    if (output === "") {
        alert('The Python requests code output is empty. Nothing to copy!');
    } else {
        navigator.clipboard.writeText(output).then(() => {
            alert('Python requests code copied to clipboard!');
        });
    }
});

// Event listener for copying the API result JSON
document.getElementById('copyResultButton').addEventListener('click', function() {
    const apiResult = document.getElementById('apiResult').textContent.trim();
    if (apiResult === "No result yet." || apiResult === "") {
        alert('The API result output is empty. Nothing to copy!');
    } else {
        navigator.clipboard.writeText(apiResult).then(() => {
            alert('API result copied to clipboard!');
        });
    }
});

// Generate the CURL command
function generateCurlCommand(apiUrl, apiKey) {
    // Remove API key from URL for curl command
    const urlWithoutKey = apiUrl.replace(/oauth_consumer_key=[^&]+&?/, '');
    return `curl -X GET "${urlWithoutKey}" \\\n  -H "Accept: application/json" \\\n  -H 'Authorization: OAuth oauth_consumer_key="${apiKey !== "API-KEY" ? apiKey : "YOUR_API_KEY"}"'`;
}

// Generate the Python requests code
function generatePythonCode(apiUrl, apiKey) {
    // Remove API key from URL for Python requests code
    const urlWithoutKey = apiUrl.replace(/oauth_consumer_key=[^&]+&?/, '');
    
    // Split URL into endpoint and query parameters
    const [endpoint, queryString] = urlWithoutKey.split('?');
    const params = {};
    const facets = [];  // List to store multiple facet values
    
    if (queryString) {
        queryString.split('&').forEach(param => {
            let [key, value] = param.split('=');
            let decodedValue = decodeURIComponent(value.replace(/\+/g, ' '));  // Convert "+" to space
            
            if (key === "facet") {
                facets.push(decodedValue);  // Add to facets list
            } else {
                params[key] = decodedValue;
            }
        });
    }

    // Add facets list to params if it contains any elements
    if (facets.length > 0) {
        params['facet'] = facets;
    }

    // Construct the Python code
    return `import requests

endpoint = "${endpoint}"
params = ${JSON.stringify(params, null, 2)}

headers = {
  "Accept": "application/json",
  "Authorization": 'OAuth oauth_consumer_key="${apiKey !== 'API-KEY' ? apiKey : 'YOUR_API_KEY'}"'
}

response = requests.get(endpoint, headers=headers, params=params)
print(response.json())`;
}


// Select the content of the API key input field when it is clicked or focused
document.getElementById('apiKeyInput').addEventListener('click', function() {
    this.select();  // Select the entire content on click
});

    
        // Event listener for the "Try it out!" button
        document.getElementById('tryItButton').addEventListener('click', function() {
            const apiKey = document.getElementById('apiKeyInput').value;
            
            // Check if API key is provided
            if (!apiKey || apiKey === "API-KEY") {
                alert('Please provide a valid API key to run the API call.');
            } else if (apiUrl) {
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        // Format JSON data and highlight it
                        const formattedJson = JSON.stringify(data, null, 2);
                        document.getElementById('apiResult').innerHTML = `<code class="language-json">${Prism.highlight(formattedJson, Prism.languages.json, 'json')}</code>`;
                    })
                    .catch(error => {
                        document.getElementById('apiResult').textContent = 'Error: ' + error;
                    });
            } else {
                document.getElementById('apiResult').textContent = 'Please convert the URL first!';
            }
        });

        function search2API(queryurl, api_key) {
            // Use try-catch to handle potential invalid URL exceptions
            let endpoint = '';
            try {
    const urlParams = new URLSearchParams(new URL(queryurl).search);
    
    
    if (queryurl.includes('search/organization?')) {
        endpoint = "https://api.deutsche-digitale-bibliothek.de/search/organization?";
    } else if (queryurl.includes('search/person?')) {
        endpoint = "https://api.deutsche-digitale-bibliothek.de/search/person?";
    } else {
        endpoint = "https://api.deutsche-digitale-bibliothek.de/search?";
    }

    let defaultValues = [`oauth_consumer_key=${api_key}`];
    
    // Properly encode the 'query' parameter using encodeURIComponent
    if (urlParams.has('query')) {
        const query = urlParams.get('query');
        defaultValues.push(`query=${query}`);
    }

    // Handle facet values properly
    const facetValues = urlParams.getAll('facetValues[]');
    if (facetValues.length > 0) {
        facetValues.forEach(facet => {
            const [fac, val] = facet.split('=');
            defaultValues.push(`facet=${fac}&${fac}=${encodeURIComponent(val)}`);
        });
    }

    // Return the final API call URL with proper encoding
    return endpoint + defaultValues.join('&');
} catch (error) {

        // If an error occurs, display an alert with the error message
        alert('Invalid URL. Please make sure the search URL is correct.');
        return ''; // Return an empty string if the URL is invalid
    }
}

    </script>
    

</body>
</html>
